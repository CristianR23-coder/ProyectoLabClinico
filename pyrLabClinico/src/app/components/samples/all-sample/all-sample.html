<div class="card p-5">
  <!-- Toolbar -->
  <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-3">
    <h2 class="text-2xl font-bold">Muestras</h2>

    <div class="flex items-center gap-2 flex-wrap">
      <span class="p-input-icon-left">
        <i class="pi pi-search text-gray-400 p-3"></i>
        <input pInputText type="text" class="w-64 max-w-full" placeholder="Buscar por código, tipo, orden…"
          [formControl]="form.controls.q" />
      </span>

      <button pButton type="button" label="Limpiar" class="p-button-text !text-red-500 hover:!bg-red-50"
        (click)="clear()" [disabled]="!(form.controls.q.value?.length)">
      </button>

      <button pButton type="button" label="Agregar muestra" icon="pi pi-plus" class="p-button-primary"
        (click)="openCreate()">
      </button>
    </div>
  </header>

  <!-- Filtros rápidos -->
  <div class="flex items-center gap-2 mb-3 flex-wrap">
    <p-select [options]="stateOptions" [disabled]="false" placeholder="Estado" [ngModel]="form.controls.state.value"
      (ngModelChange)="form.patchValue({ state: $event })">
    </p-select>

    <p-select [options]="typeOptions" placeholder="Tipo de muestra" [ngModel]="form.controls.type.value"
      (ngModelChange)="form.patchValue({ type: $event })">
    </p-select>
  </div>

  <!-- Tabla -->
  <p-table [value]="(rows$ | async) ?? []" dataKey="id" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10,20,50]"
    [responsiveLayout]="'scroll'" [tableStyle]="{ 'min-width': '72rem' }">

    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="barcode">Código <p-sortIcon field="barcode"></p-sortIcon></th>
        <th pSortableColumn="type">Tipo <p-sortIcon field="type"></p-sortIcon></th>
        <th pSortableColumn="orderId">Orden <p-sortIcon field="orderId"></p-sortIcon></th>
        <th pSortableColumn="drawDate">Fecha toma <p-sortIcon field="drawDate"></p-sortIcon></th>
        <th pSortableColumn="state">Estado <p-sortIcon field="state"></p-sortIcon></th>
        <th class="w-40">Acciones</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-s>
      <tr>
        <td class="font-mono">{{ s.barcode || '—' }}</td>
        <td>{{ s.type }}</td>
        <td>#{{ s.orderId }}</td>
        <td>{{ s.drawDate ? (s.drawDate | date:'dd/MM/yyyy HH:mm') : '—' }}</td>
        <td><p-tag [severity]="tagSeverity(s.state)" [value]="s.state"></p-tag></td>
        <td class="flex gap-2">
          <button pButton icon="pi pi-eye" [text]="true" [rounded]="true" severity="info" pTooltip="Ver"
            (click)="onView(s)"></button>
          <button pButton icon="pi pi-pencil" [text]="true" [rounded]="true" pTooltip="Editar"
            (click)="openEdit(s.id)"></button>
          <button pButton icon="pi pi-trash" [text]="true" [rounded]="true" severity="danger" pTooltip="Eliminar"
            (click)="onDelete(s)"></button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="6" class="text-center italic text-gray-500 py-6">
          No hay muestras que coincidan con el filtro.
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Crear -->
  <p-dialog [(visible)]="showCreate" [modal]="true" [draggable]="false" [resizable]="false" [style]="{ width: '880px' }"
    (onHide)="closeCreate()">
    <ng-template pTemplate="header"><span class="font-bold text-xl">Nueva muestra</span></ng-template>
    <app-create-sample (created)="onCreated($event)" (cancelled)="closeCreate()"></app-create-sample>
  </p-dialog>

  <!-- Editar -->
  <p-dialog [(visible)]="showEdit" [modal]="true" [draggable]="false" [resizable]="false" [style]="{ width: '880px' }"
    (onHide)="closeEdit()">
    <ng-template pTemplate="header"><span class="font-bold text-xl">Editar muestra</span></ng-template>
    <app-update-sample *ngIf="selectedId!=null" [sampleId]="selectedId" (saved)="onEdited($event)"
      (cancelled)="closeEdit()">
    </app-update-sample>
  </p-dialog>

  <!-- Details dialog -->
  <p-dialog [(visible)]="showView" [modal]="true" [draggable]="false" [resizable]="false" [appendTo]="'body'"
    [style]="{ width: '720px' }" (onHide)="closeView()">

    <ng-template pTemplate="header">
      <span class="font-bold text-xl">Sample details</span>
    </ng-template>

    <!-- ✅ only render viewer when we have a sample -->
    <app-view-sample *ngIf="selectedDetail" [sample]="selectedDetail" (editRequested)="openEdit($event)"
      (deleteRequested)="onDelete($event)" (close)="closeView()">
    </app-view-sample>
  </p-dialog>

</div>