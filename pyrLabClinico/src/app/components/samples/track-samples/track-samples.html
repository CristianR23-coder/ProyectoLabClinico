<div class="space-y-6">
    <h2 class="text-2xl font-bold">Seguimiento de muestras por orden</h2>

    <ng-container *ngIf="(groups$ | async) as groups; else empty">
        <div *ngFor="let g of groups" class="rounded-lg border border-surface-200 p-4">
            <!-- Cabecera de orden -->
            <div class="flex items-center justify-between mb-3">
                <div class="font-semibold">
                    {{ orderTitle(g.order) }}
                    <span class="text-sm text-color-secondary ml-2">
                        {{ g.order.orderDate | date:'dd/MM/yyyy HH:mm' }}
                    </span>
                </div>
                <p-tag [value]="g.order.state" severity="info"></p-tag>
            </div>

            <p-table [value]="g.samples" [tableStyle]="{'min-width':'64rem'}" dataKey="id">
                <ng-template pTemplate="header">
                    <tr>
                        <th style="width:10rem">Muestra</th>
                        <th style="width:12rem">Código</th>
                        <th style="width:12rem">Tipo</th>
                        <th class="text-center">Flujo</th>
                        <th style="width:11rem" class="text-center">Rechazada</th>
                        <th style="width:12rem" class="text-center">Final</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-s>
                    <tr>
                        <td>#{{ s.id }}</td>
                        <td class="font-mono">{{ s.barcode || '—' }}</td>
                        <td>{{ s.type }}</td>

                        <!-- Flujo por pasos -->
                        <td class="text-center">
                            <div class="flex items-center justify-center gap-4 flex-wrap">
                                <label *ngFor="let step of flow" class="inline-flex items-center gap-2">
                                    <p-checkbox [binary]="true" [disabled]="!canInteract(s) || s.state==='RECHAZADA'"
                                        [ngModel]="isStepChecked(s, step)"
                                        (ngModelChange)="onToggleStep(s, step, $event)"></p-checkbox>
                                    <span class="text-sm">{{ stepLabel(step) }}</span>
                                </label>
                            </div>
                        </td>

                        <!-- Rechazada + editar motivo -->
                        <td class="text-center">
                            <div class="inline-flex items-center gap-2">
                                <p-checkbox [binary]="true" [ngModel]="s.state==='RECHAZADA'"
                                    [disabled]="!canInteract(s)" (ngModelChange)="onToggleRejected(s, $event)">
                                </p-checkbox>
                                <button *ngIf="s.state==='RECHAZADA'" pButton icon="pi pi-pencil"
                                    class="p-button-text p-button-sm" pTooltip="Editar motivo"
                                    (click)="editRejectReason(s)">
                                </button>
                            </div>
                        </td>

                        <!-- Final -->
                        <td class="text-center">
                            <p-tag [value]="finalLabel(s)" [severity]="finalSeverity(s)"></p-tag>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="6" class="text-center py-4 text-color-secondary">
                            Sin muestras asociadas a esta orden.
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </ng-container>

    <ng-template #empty>
        <div class="p-6 text-center text-color-secondary border border-dashed rounded-lg">
            No hay órdenes con muestras registradas aún.
        </div>
    </ng-template>
</div>

<!-- Diálogo: motivo de rechazo -->
<p-dialog [(visible)]="rejectVisible" [modal]="true" [draggable]="false" [resizable]="false"
    [style]="{ width: '560px' }" (onHide)="cancelReject()">
    <ng-template pTemplate="header">
        <span class="font-bold text-lg">Motivo de rechazo</span>
    </ng-template>

    <form [formGroup]="rejectForm" class="space-y-3">
        <div class="text-sm text-color-secondary">
            Muestra: <span class="font-medium">#{{ rejectingSample?.id }}</span>
            · Tipo: <span class="font-medium">{{ rejectingSample?.type }}</span>
            · Código: <span class="font-medium">{{ rejectingSample?.barcode || '—' }}</span>
        </div>

        <textarea pTextarea rows="5" formControlName="observations" class="w-full"
            placeholder="Describe claramente la razón del rechazo"></textarea>
        <small class="p-error"
            *ngIf="rejectForm.controls.observations.invalid && rejectForm.controls.observations.touched">
            Requerido.
        </small>

        <div class="flex items-center justify-end gap-2 pt-2">
            <button pButton type="button" class="p-button-text !text-red-500 hover:!bg-red-50" label="Cancelar" (click)="cancelReject()"></button>
            <button pButton type="button" label="Guardar" icon="pi pi-check" (click)="confirmReject()"></button>
        </div>
    </form>
</p-dialog>