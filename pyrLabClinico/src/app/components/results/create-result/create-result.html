<div class="min-w-[320px]">
  @if (loading) {
  <div class="p-4 text-center text-color-secondary">Cargando…</div>
  } @else {
  <form [formGroup]="form" class="space-y-5">
    <!-- Selección de contexto -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <!-- Orden -->
      <div>
        <label class="block mb-1 text-sm font-semibold">Orden <span class="text-red-500">*</span></label>
        <p-select formControlName="orderId" [options]="orders" optionValue="id" [showClear]="true"
          placeholder="Selecciona orden">
          <ng-template pTemplate="item" let-o>ORD-{{ o.id }} — {{ o?.patient?.lastName ?? '' }}, {{
            o?.patient?.firstName ?? '' }}</ng-template>
          <ng-template pTemplate="selectedItem" let-o>ORD-{{ o?.id }}</ng-template>
        </p-select>
      </div>

      <!-- Muestra -->
      <div>
        <label class="block mb-1 text-sm font-semibold">Muestra <span class="text-red-500">*</span></label>
        <p-select formControlName="sampleId" [options]="allowedSamples" optionValue="id" [showClear]="true"
          placeholder="Muestra de la orden">
          <ng-template pTemplate="item" let-s>#{{ s.id }} · {{ s.type }} · {{ s.barcode || 's/código' }}</ng-template>
          <ng-template pTemplate="selectedItem" let-s>#{{ s?.id }} · {{ s?.type }}</ng-template>
        </p-select>
      </div>

      <!-- Examen -->
      <div>
        <label class="block mb-1 text-sm font-semibold">Examen <span class="text-red-500">*</span></label>
        <p-select formControlName="examId" [options]="allowedExams" optionValue="id" [showClear]="true"
          placeholder="Examen de la orden">
          <ng-template pTemplate="item" let-e>{{ e.name }} ({{ e.code }})</ng-template>
          <ng-template pTemplate="selectedItem" let-e>{{ e?.name }}</ng-template>
        </p-select>
      </div>
    </div>

    <!-- Parámetro -->
    <div>
      <label class="block mb-1 text-sm font-semibold">Parámetro <span class="text-red-500">*</span></label>
      <p-select formControlName="parameterId" [options]="allowedParams" optionValue="id" [showClear]="true"
        placeholder="Selecciona parámetro">
        <ng-template pTemplate="item" let-p>
          {{ p.name }} <span class="text-color-secondary">({{ p.typeValue }})</span>
        </ng-template>
        <ng-template pTemplate="selectedItem" let-p>{{ p?.name }}</ng-template>
      </p-select>
      <div class="text-sm text-color-secondary mt-1" *ngIf="param?.typeValue==='NUMERICO'">
        Ref.: {{ param?.refMin ?? '—' }} – {{ param?.refMax ?? '—' }} {{ param?.unit || '' }}
      </div>
    </div>

    <!-- Captura del valor -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <ng-container [ngSwitch]="param?.typeValue">
        <!-- numérico -->
        <div *ngSwitchCase="'NUMERICO'">
          <label class="block mb-1 text-sm font-semibold">Valor ({{ param?.unit || '—' }})</label>
          <p-inputNumber formControlName="numValue" [useGrouping]="false"></p-inputNumber>
        </div>

        <!-- texto -->
        <div *ngSwitchDefault class="md:col-span-2">
          <label class="block mb-1 text-sm font-semibold">Valor (texto)</label>
          <input pInputText formControlName="textValue" />
        </div>
      </ng-container>

      <div>
        <label class="block mb-1 text-sm font-semibold">Unidades</label>
        <input pInputText formControlName="units" placeholder="Opcional (toma por defecto la del parámetro)" />
      </div>

      <div>
        <label class="block mb-1 text-sm font-semibold">Fecha resultado</label>
        <p-datepicker formControlName="dateResult" [showIcon]="true" appendTo="body"></p-datepicker>
      </div>

      <div>
        <label class="block mb-1 text-sm font-semibold">Estado</label>
        <input pInputText [value]="fixedState" readonly />
      </div>


      <div class="md:col-span-3">
        <label class="block mb-1 text-sm font-semibold">Comentario</label>
        <textarea pTextarea formControlName="comment" rows="3" class="w-full"></textarea>
      </div>
    </div>

    <p-divider></p-divider>

    <div class="flex items-center justify-end gap-3">
      <button pButton type="button" class="p-button-text !text-red-500 hover:!bg-red-50" label="Cancelar"
        (click)="cancel()"></button>
      <button pButton type="button" label="Guardar" icon="pi pi-check" severity="success" (click)="save()"
        [disabled]="form.invalid"></button>
    </div>
  </form>
  }
</div>