<div class="card p-5">
  <header class="flex items-center justify-between mb-3">
    <h3 class="text-lg font-bold">Resultados</h3>
    <div class="flex items-center gap-2">
      <span class="p-input-icon-left">
        <i class="pi pi-search text-gray-400 p-3"></i>
        <input pInputText type="text" class="w-64 max-w-full" placeholder="Buscar por método, unidad, comentario, valor"
          [formControl]="form.controls.q" />
      </span>

      <p-select [options]="['PENDIENTE','CAPTURADO','VALIDADO','RECHAZADO']" [ngModel]="form.controls.state.value"
        placeholder="Estado" [showClear]="true" (ngModelChange)="form.patchValue({ state: $event })">
      </p-select>

      <button pButton type="button" label="Limpiar" class="p-button-text !text-red-500 hover:!bg-red-50"
        (click)="clear()" [disabled]="!(form.controls.q.value?.length || form.controls.state.value)">
      </button>

      <!-- Botón Agregar -->
      <button pButton type="button" label="Agregar resultado" icon="pi pi-plus" class="p-button-primary"
        (click)="openCreate()"></button>
    </div>
  </header>

  <p-table [value]="(rows$ | async) ?? []" dataKey="id" [tableStyle]="{'min-width':'78rem'}">
    <ng-template pTemplate="header">
      <tr>
        <th>ID</th>
        <th>Orden</th>
        <th>Muestra</th>
        <th>Examen</th>
        <th>Parámetro</th>
        <th>Valor</th>
        <th>Unidades</th>
        <th>Fuera rango</th>
        <th>Fecha</th>
        <th>Estado</th>
        <th class="w-40">Acciones</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-r>
      <tr>
        <td>{{ r.id }}</td>
        <td>#{{ r.orderId }}</td>
        <td>#{{ r.sampleId }}</td>
        <td>#{{ r.examId }}</td>
        <td>#{{ r.parameterId }}</td>
        <td>
          <ng-container *ngIf="r.numValue != null; else textVal">
            {{ r.numValue }}
          </ng-container>
          <ng-template #textVal>{{ r.textValue || '—' }}</ng-template>
        </td>
        <td>{{ r.units || '—' }}</td>
        <td>
          <span *ngIf="r.outRange === true" class="text-red-600 font-semibold">Sí</span>
          <span *ngIf="r.outRange === false" class="text-green-600">No</span>
          <span *ngIf="r.outRange == null">—</span>
        </td>
        <td>{{ r.dateResult ? (r.dateResult | date:'dd/MM/yyyy HH:mm') : '—' }}</td>
        <td><p-tag [value]="r.resultState" [severity]="tagSeverity(r.resultState)"></p-tag></td>
        <td class="flex gap-2">
          <button pButton icon="pi pi-eye" [text]="true" [rounded]="true" severity="info"
            (click)="openView(r.id!)"></button>
          <button pButton icon="pi pi-check-circle" [text]="true" [rounded]="true" severity="success"
            (click)="openValidate(r.id!)" [disabled]="r.resultState === 'VALIDADO'"></button>
            <button pButton icon="pi pi-pencil" [text]="true" [rounded]="true" (click)="openEdit(r.id!)"></button>
            <button pButton icon="pi pi-trash" [text]="true" [rounded]="true" severity="danger"
              (click)="onDelete(r.id!)"></button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="11" class="text-center py-6">Sin resultados</td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Diálogo: Crear -->
  <p-dialog [(visible)]="showCreate" [modal]="true" [draggable]="false" [resizable]="false" [style]="{ width: '760px' }"
    (onHide)="closeCreate()">
    <ng-template pTemplate="header"><span class="font-bold text-xl">Nuevo resultado</span></ng-template>

    <app-create-result [orderId]="orderId" [sampleId]="sampleId" [examId]="examId" (saved)="closeCreate()"
      (cancelled)="closeCreate()">
    </app-create-result>
  </p-dialog>

  <!-- Diálogo: Editar -->
  <p-dialog [(visible)]="showEdit" [modal]="true" [style]="{width:'760px'}" (onHide)="closeEdit()">
    <ng-template pTemplate="header"><span class="font-bold text-xl">Editar resultado</span></ng-template>
    <app-update-result *ngIf="selectedId!=null" [resultId]="selectedId" (saved)="closeEdit()"
      (cancelled)="closeEdit()"></app-update-result>
  </p-dialog>

  <!-- Diálogo: Ver -->
  <p-dialog [(visible)]="showView" [modal]="true" [style]="{width:'760px'}" (onHide)="closeView()">
    <ng-template pTemplate="header"><span class="font-bold text-xl">Detalle del resultado</span></ng-template>
    <app-view-result *ngIf="selectedId!=null" [resultId]="selectedId" (closed)="closeView()"></app-view-result>
  </p-dialog>

  <!-- ✅ Diálogo: Validar/Rechazar -->
  <p-dialog [(visible)]="showValidate" [modal]="true" [draggable]="false" [resizable]="false"
    [style]="{ width: '760px' }" (onHide)="closeValidate()">
    <ng-template pTemplate="header">
      <span class="font-bold text-xl">Validación de resultado</span>
    </ng-template>

    <app-validated-result *ngIf="selectedId!=null" [resultId]="selectedId" (validated)="closeValidate()"
      (rejected)="closeValidate()" (cancelled)="closeValidate()">
    </app-validated-result>
  </p-dialog>

</div>