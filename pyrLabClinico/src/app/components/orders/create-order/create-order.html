<form [formGroup]="form" class="space-y-5">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
    <!-- Paciente -->
    <div>
      <label class="block mb-1 text-sm font-semibold">
        Paciente <span class="text-red-500">*</span>
      </label>
      <p-select formControlName="patientId"
                [options]="patients"
                optionLabel="lastName"
                optionValue="id"
                [filter]="true"
                filterBy="lastName,firstName,docNumber"
                placeholder="Selecciona paciente">
        <ng-template pTemplate="item" let-p>
          <div class="flex flex-col">
            <span>{{ p.lastName }}, {{ p.firstName }}</span>
            <small class="text-color-secondary">{{ p.docType }} {{ p.docNumber }}</small>
          </div>
        </ng-template>
        <ng-template pTemplate="selectedItem" let-p>
          <span *ngIf="p">{{ p.lastName }}, {{ p.firstName }}</span>
        </ng-template>
      </p-select>
      <small class="p-error" *ngIf="form.get('patientId')?.invalid && form.get('patientId')?.touched">
        Requerido.
      </small>
    </div>

    <!-- Prioridad -->
    <div>
      <label class="block mb-1 text-sm font-semibold">Prioridad</label>
      <p-select formControlName="priority"
                [options]="priorityOptions"
                optionLabel="label"
                optionValue="value"
                placeholder="Selecciona prioridad">
      </p-select>
    </div>

    <!-- Estado fijo -->
    <div>
      <label class="block mb-1 text-sm font-semibold">Estado</label>
      <input pInputText [value]="fixedState" readonly />
    </div>

    <!-- Médico (opcional) -->
    <div>
      <label class="block mb-1 text-sm font-semibold">Médico (opcional)</label>
      <p-select formControlName="doctorId"
                [options]="doctors"
                optionLabel="name"
                optionValue="id"
                [filter]="true"
                filterBy="name,docNumber"
                placeholder="Selecciona médico">
        <ng-template pTemplate="item" let-d>
          <div class="flex flex-col">
            <span>{{ d.name }}</span>
            <small class="text-color-secondary">{{ d.docNumber }}</small>
          </div>
        </ng-template>
      </p-select>
    </div>

    <!-- Aseguradora (opcional) -->
    <div>
      <label class="block mb-1 text-sm font-semibold">Aseguradora (opcional)</label>
      <p-select formControlName="insuranceId"
                [options]="insurances"
                optionLabel="name"
                optionValue="id"
                [filter]="true"
                filterBy="name,nit"
                placeholder="Selecciona aseguradora">
      </p-select>
    </div>

    <!-- Fecha de orden -->
    <div>
      <label class="block mb-1 text-sm font-semibold">Fecha de orden</label>
      <p-datepicker formControlName="orderDate" [showIcon]="true" inputId="orderDate" appendTo="body"></p-datepicker>
    </div>

    <!-- Observaciones -->
    <div class="md:col-span-3">
      <label class="block mb-1 text-sm font-semibold">Observación</label>
      <textarea pTextarea formControlName="observations"
                rows="3"
                placeholder="Observación (opcional)"
                class="w-full"></textarea>
    </div>
  </div>

  <p-divider></p-divider>

  <!-- Sección: Exámenes a realizar -->
  <div>
    <div class="flex items-end flex-wrap gap-3 mb-3" [formGroup]="itemForm">
      <div class="min-w-[340px]">
        <label class="block mb-1 text-sm font-semibold">Examen</label>
        <p-select formControlName="examId"
                  [options]="exams"
                  optionLabel="name"
                  optionValue="id"
                  [filter]="true"
                  filterBy="code,name,specimenType"
                  placeholder="Selecciona un examen">
          <ng-template pTemplate="item" let-e>
            <div class="flex items-center justify-between gap-3">
              <span>{{ e.code }} — {{ e.name }}</span>
            </div>
          </ng-template>
          <ng-template pTemplate="selectedItem" let-e>
            <span *ngIf="e">{{ e.code }} — {{ e.name }}</span>
          </ng-template>
        </p-select>
        <small class="p-error" *ngIf="itemForm.get('examId')?.invalid && itemForm.get('examId')?.touched">Requerido.</small>
      </div>

      <div>
        <button pButton type="button" label="Agregar examen" icon="pi pi-plus"
                (click)="addExam()" [disabled]="itemForm.invalid"></button>
      </div>

      <div class="ml-auto text-right">
        <div class="text-sm text-color-secondary">Total exámenes</div>
        <div class="text-xl font-semibold">{{ form.controls.netTotal.value || 0 | number:'1.0-0' }}</div>
      </div>
    </div>

    <p-table [value]="items" [tableStyle]="{ 'min-width':'60rem' }" dataKey="examId">
      <ng-template pTemplate="header">
        <tr>
          <th style="width:10rem">Código</th>
          <th>Nombre</th>
          <th style="width:10rem" class="text-right">Precio</th>
          <th style="width:12rem">Estado examen</th>
          <th style="width:6rem" class="text-center">Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-it>
        <tr>
          <td>{{ it.code }}</td>
          <td>{{ it.name }}</td>
          <td class="text-right">{{ it.price | number:'1.0-0' }}</td>
          <td>
            <ng-container *ngIf="examStatus(it) as st; else noSt">
              <p-tag [value]="st" [severity]="examStatusSeverity(st)"></p-tag>
            </ng-container>
            <ng-template #noSt>—</ng-template>
          </td>
          <td class="text-center">
            <button pButton icon="pi pi-trash" [text]="true" [rounded]="true" severity="danger"
                    (click)="removeItem(it)" pTooltip="Quitar"></button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="text-center py-3 text-color-secondary">
            No has agregado exámenes a esta orden.
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <p-divider></p-divider>

  <!-- Footer -->
  <div class="flex items-center justify-end gap-3">
    <button pButton type="button"
            class="p-button-text !text-red-500 hover:!bg-red-50"
            label="Cancelar" (click)="cancel()"></button>
    <button pButton type="button" label="Guardar"
            icon="pi pi-check" severity="success"
            (click)="save()" [disabled]="!canSave"></button>
  </div>
</form>
