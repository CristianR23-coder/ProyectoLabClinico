<p-dialog
  [header]="order ? ('Orden ' + order.numero) : 'Orden'"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [closable]="true"
  [appendTo]="appendToBody ? 'body' : null"
  [style]="{ width: '920px', maxWidth: '98vw' }"
  [breakpoints]="{ '960px': '95vw', '640px': '98vw' }"
  [(visible)]="visible"
  (onHide)="onHide()"
>
  <ng-container *ngIf="order as o; else empty">
    <!-- Encabezado -->
    <section class="grid grid-cols-12 gap-3">
      <div class="col-span-12 md:col-span-8">
        <h3 class="text-xl font-semibold">
          {{ o.paciente }}
          <span *ngIf="o.pacienteEdad != null" class="text-sm text-gray-500 ml-1">• {{ o.pacienteEdad }} años</span>
        </h3>
        <div class="text-sm text-gray-600 mt-1">
          <span *ngIf="o.pacienteDoc">ID: <span class="font-mono">{{ o.pacienteDoc }}</span></span>
          <span *ngIf="o.aseguradora" class="ml-2">| Aseguradora: {{ o.aseguradora }}</span>
        </div>
        <div class="text-sm text-gray-600">
          Médico: <span class="font-medium">{{ o.medico }}</span>
          <span class="ml-2">| Fecha:
            <span class="font-medium">{{ o.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}</span>
          </span>
        </div>
      </div>
      <div class="col-span-12 md:col-span-4 flex md:justify-end items-start gap-2">
        <p-tag [value]="o.estado" [severity]="getStatusSeverity(o.estado)" styleClass="capitalize"></p-tag>
        <button pButton type="button" icon="pi pi-print" class="p-button-text" pTooltip="Imprimir" (click)="onPrint()"></button>
        <button pButton type="button" icon="pi pi-pencil" class="p-button-text" pTooltip="Editar" (click)="onEdit()"></button>
      </div>
    </section>

    <p-divider></p-divider>

    <!-- Muestras -->
    <section *ngIf="o.muestras?.length">
      <h4 class="font-semibold mb-2">Muestras</h4>
      <p-table [value]="o.muestras ?? []" [responsiveLayout]="'scroll'" styleClass="rounded-xl overflow-hidden">
        <ng-template pTemplate="header">
          <tr>
            <th>Tipo</th>
            <th class="whitespace-nowrap">Código barra</th>
            <th class="whitespace-nowrap">Fecha toma</th>
            <th>Observación</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-m>
          <tr>
            <td>{{ m.tipo }}</td>
            <td class="font-mono">{{ m.codigoBarra || '—' }}</td>
            <td>{{ m.fechaToma ? (m.fechaToma | date:'dd/MM/yyyy HH:mm') : '—' }}</td>
            <td>{{ m.observacion || '—' }}</td>
          </tr>
        </ng-template>
      </p-table>
    </section>

    <p-divider *ngIf="o.muestras?.length && (o.examenes?.length || true)"></p-divider>

    <!-- Exámenes solicitados -->
    <section *ngIf="o.examenes?.length">
      <div class="flex items-center justify-between mb-2">
        <h4 class="font-semibold">Exámenes solicitados</h4>
        <div class="text-sm text-gray-600">
          Pruebas: <span class="font-semibold">{{ totalPruebas }}</span>
          <span class="ml-3">Total: <span class="font-bold">{{ totalValor | currency: currencyCode:'symbol-narrow':'1.0-0' }}</span></span>
        </div>
      </div>

      <p-table [value]="o.examenes ?? []" [responsiveLayout]="'scroll'" styleClass="rounded-xl overflow-hidden">
        <ng-template pTemplate="header">
          <tr>
            <th class="whitespace-nowrap">Código</th>
            <th>Examen</th>
            <th class="whitespace-nowrap">Panel</th>
            <th class="text-right">Precio</th>
            <th class="whitespace-nowrap">Estado</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-x>
          <tr>
            <td class="font-mono">{{ x.codigo || '—' }}</td>
            <td>{{ x.nombre }}</td>
            <td>{{ x.panelId || '—' }}</td>
            <td class="text-right">{{ (x.precio ?? 0) | currency: currencyCode:'symbol-narrow':'1.0-0' }}</td>
            <td>
              <p-tag *ngIf="x.estado"
                     [value]="x.estado"
                     [severity]="x.estado==='listo' ? 'success' : (x.estado==='en-proceso' ? 'info' : 'warn')"
                     styleClass="capitalize">
              </p-tag>
              <span *ngIf="!x.estado">—</span>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </section>

    <!-- Observaciones -->
    <section *ngIf="o.observaciones" class="mt-3">
      <h4 class="font-semibold mb-1">Observaciones</h4>
      <p class="text-sm whitespace-pre-wrap">{{ o.observaciones }}</p>
    </section>

    <!-- Resultados -->
    <section *ngIf="o.resultados?.length" class="mt-4">
      <h4 class="font-semibold mb-2">Resultados</h4>
      <p-table [value]="o.resultados ?? []" [responsiveLayout]="'scroll'">
        <ng-template pTemplate="header">
          <tr>
            <th>Examen</th>
            <th>Parámetro</th>
            <th>Resultado</th>
            <th>Unidad</th>
            <th>Referencia</th>
            <th>Bandera</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-r>
          <tr>
            <td>{{ r.examen || '—' }}</td>
            <td>{{ r.parametro }}</td>
            <td class="font-semibold">{{ r.resultado }}</td>
            <td>{{ r.unidad || '—' }}</td>
            <td>{{ r.referencia || '—' }}</td>
            <td>
              <p-tag *ngIf="r.flag"
                     [value]="r.flag"
                     [severity]="r.flag==='H' ? 'danger' : (r.flag==='L' ? 'warn' : 'success')">
              </p-tag>
              <span *ngIf="!r.flag">—</span>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </section>
  </ng-container>

  <ng-template #empty>
    <div class="text-center text-gray-500 italic py-6">
      No hay datos de la orden para mostrar.
    </div>
  </ng-template>

  <!-- Footer -->
  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <button pButton type="button" label="Cerrar" class="p-button-text !text-red-500 hover:!bg-red-50" (click)="onHide()"></button>
      <button pButton type="button" icon="pi pi-print" label="Imprimir" (click)="onPrint()"></button>
      <button pButton type="button" icon="pi pi-pencil" class="p-button-success" label="Editar" (click)="onEdit()"></button>
    </div>
  </ng-template>
</p-dialog>
