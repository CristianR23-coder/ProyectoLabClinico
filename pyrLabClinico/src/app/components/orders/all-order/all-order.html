<div class="card p-5">
  <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-3">
    <h2 class="text-2xl font-bold">Órdenes</h2>

    <div class="flex items-center gap-2 flex-wrap">
      <span class="p-input-icon-left">
        <i class="pi pi-search text-gray-400 p-3"></i>
        <input #q pInputText type="text" class="w-64 max-w-full" placeholder="Buscar por código, paciente, documento…"
          aria-label="Buscar órdenes" (input)="dt.filterGlobal(($any($event.target).value || ''), 'contains')" />
      </span>

      <button pButton type="button" label="Limpiar" class="p-button-text !text-red-500 hover:!bg-red-50"
        (click)="q.value = ''; dt.reset(); clear()" [disabled]="!(q.value.length)"></button>

      <button pButton type="button" label="Agregar orden" icon="pi pi-plus" class="p-button-primary" severity="success"
        (click)="openCreate()"></button>
    </div>
  </header>

  <div class="h-0.5 w-16 bg-emerald-500 mb-3"></div>

  <div class="flex flex-wrap items-center gap-2 mb-3">
    <!-- Filtros por estado -->
    <button pButton type="button" label="Todas" icon="pi pi-list"
      [severity]="form.value.state === undefined ? 'primary' : 'secondary'"
      (click)="form.patchValue({ state: undefined })"></button>

    <button pButton type="button" label="Creadas" icon="pi pi-plus-circle"
      [severity]="form.value.state === 'CREADA' ? 'primary' : 'secondary'"
      (click)="form.patchValue({ state: 'CREADA' })"></button>

    <button pButton type="button" label="Tomadas" icon="pi pi-check"
      [severity]="form.value.state === 'TOMADA' ? 'primary' : 'secondary'"
      (click)="form.patchValue({ state: 'TOMADA' })"></button>

    <button pButton type="button" label="Anuladas" icon="pi pi-times"
      [severity]="form.value.state === 'ANULADA' ? 'danger' : 'secondary'"
      (click)="form.patchValue({ state: 'ANULADA' })"></button>

    <button pButton type="button" label="En proceso" icon="pi pi-spinner"
      [severity]="form.value.state === 'EN_PROCESO' ? 'warn' : 'secondary'"
      (click)="form.patchValue({ state: 'EN_PROCESO' })"></button>

    <button pButton type="button" label="Entregadas" icon="pi pi-send"
      [severity]="form.value.state === 'ENTREGADA' ? 'help' : 'secondary'"
      (click)="form.patchValue({ state: 'ENTREGADA' })"></button>

    <button pButton type="button" label="Validadas" icon="pi pi-shield"
      [severity]="form.value.state === 'VALIDADA' ? 'success' : 'secondary'"
      (click)="form.patchValue({ state: 'VALIDADA' })"></button>
  </div>

  <!-- Tabla -->
  <p-table #dt [value]="(rows$ | async) ?? []" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10,20,50]"
    dataKey="id" sortMode="single" [tableStyle]="{'min-width':'72rem'}" [globalFilterFields]="[
    'id',
    'patient.firstName',
    'patient.lastName',
    'patient.docNumber',
    'state'
  ]">

    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="id">Código <p-sortIcon field="id"></p-sortIcon></th>
        <th pSortableColumn="patient.lastName">Paciente <p-sortIcon field="patient.lastName"></p-sortIcon></th>
        <th pSortableColumn="orderDate">Fecha <p-sortIcon field="orderDate"></p-sortIcon></th>
        <th pSortableColumn="state">Estado <p-sortIcon field="state"></p-sortIcon></th>
        <th class="text-right" pSortableColumn="netTotal">Total <p-sortIcon field="netTotal"></p-sortIcon></th>
        <th class="w-44">Acciones</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-row>
      <tr>
        <td>ORD-{{ row.id }}</td>
        <td>
          {{ row.patient?.firstName }} {{ row.patient?.lastName }}
          <small class="text-color-secondary" *ngIf="row.patient?.docNumber">
            ({{ row.patient.docNumber }})
          </small>
        </td>
        <td>{{ row.orderDate | date:'dd/MM/yyyy HH:mm' }}</td>
        <td><p-tag [value]="row.state" [severity]="tagSeverity(row.state)"></p-tag></td>
        <td class="text-right">{{ row.netTotal || 0 | number:'1.0-0' }}</td>
        <td class="flex gap-2">
          <button pButton icon="pi pi-eye" [text]="true" [rounded]="true" severity="info" (click)="openView(row.id)"
            pTooltip="Ver"></button>

          <!-- Editar abre diálogo -->
          <button pButton icon="pi pi-pencil" [text]="true" [rounded]="true" severity="success"
            (click)="openEdit(row.id)" pTooltip="Editar"></button>

          <button pButton icon="pi pi-trash" [text]="true" [rounded]="true" severity="danger"
            (click)="onViewDelete(row.id)" pTooltip="Eliminar"></button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="6" class="text-center py-6">Sin resultados</td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Modal: Create Order -->
  <p-dialog [(visible)]="showCreate" [modal]="true" [draggable]="false" [resizable]="false"
    [style]="{ width: '1000px' }" (onHide)="closeCreate()">
    <ng-template pTemplate="header">
      <span class="font-bold text-xl md:text-2xl">Nueva orden</span>
    </ng-template>
    <app-create-order (created)="onCreatedOrder($event)" (cancelled)="closeCreate()"></app-create-order>
  </p-dialog>

  <!-- Modal: Edit Order -->
  <p-dialog [(visible)]="showEdit" [modal]="true" [draggable]="false" [resizable]="false" [style]="{ width: '1200px' }"
    (onHide)="closeEdit()">
    <ng-template pTemplate="header">
      <span class="font-bold text-xl md:text-2xl">Editar orden</span>
    </ng-template>

    <app-edit-order *ngIf="selectedOrderId != null" [orderId]="selectedOrderId" (saved)="onEditedOrder($event)"
      (cancelled)="closeEdit()">
    </app-edit-order>
  </p-dialog>

  <!-- Modal: Detalle -->
  <p-dialog [(visible)]="showView" [modal]="true" [draggable]="false" [resizable]="false" [style]="{ width: '1000px' }"
    (onHide)="closeView()">
    <ng-template pTemplate="header">
      <span class="font-bold text-xl md:text-2xl">Detalle de orden</span>
    </ng-template>

    <app-view-order *ngIf="viewedOrderId != null" [orderId]="viewedOrderId" (editRequested)="onViewEdit($event)"
      (deleteRequested)="onViewDelete($event)">
    </app-view-order>
  </p-dialog>

</div>