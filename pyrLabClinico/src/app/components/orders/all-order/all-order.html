<section class="max-w-[1200px] mx-auto p-4">
  <!-- Toolbar -->
  <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-3">
    <h2 class="text-2xl font-bold">√ìrdenes</h2>

    <div class="flex items-center gap-2 flex-wrap">
      <span class="p-input-icon-left">
        <i class="pi pi-search text-gray-400 p-3"></i>
        <input pInputText type="text" placeholder="Buscar por n√∫mero, paciente, m√©dico‚Ä¶" [(ngModel)]="globalQuery"
          (input)="dt.filterGlobal(globalQuery, 'contains')" class="w-64 max-w-full" aria-label="Buscar √≥rdenes" />
      </span>

      <button pButton type="button" label="Limpiar" class="p-button-text !text-red-500 hover:!bg-red-50"
        (click)="clearSearch()" [disabled]="!globalQuery">
      </button>

      <button pButton type="button" label="Agregar orden" icon="pi pi-plus" class="p-button-primary" (click)="onAdd()"
        [routerLink]="['/ordenes/nueva']">
      </button>
    </div>
  </header>

  <!-- Tabs por estado (v20): Tabs sin panels, solo tablist; usamos [(value)] -->
  <p-tabs [(value)]="estadoValue" (valueChange)="onEstadoChange($event)" scrollable class="mb-3">
    <p-tablist>
      <p-tab *ngFor="let t of estadoTabs" [value]="t.value">
        <i [class]="t.icon" class="mr-2"></i>{{ t.label }}
      </p-tab>
    </p-tablist>
  </p-tabs>

  <!-- Tabla -->
  <p-table #dt [value]="orders" dataKey="id" [paginator]="true" [rows]="pageSize" [rowsPerPageOptions]="[5,10,20,50]"
    [responsiveLayout]="'scroll'" [globalFilterFields]="globalFields" sortMode="multiple" [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando {first}‚Äì{last} de {totalRecords}" class="rounded-xl overflow-hidden shadow-sm">
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="numero" class="whitespace-nowrap">
          N√∫mero <p-sortIcon field="numero"></p-sortIcon>
        </th>
        <th pSortableColumn="paciente" class="whitespace-nowrap">
          Paciente <p-sortIcon field="paciente"></p-sortIcon>
        </th>
        <th pSortableColumn="medico" class="whitespace-nowrap">
          M√©dico <p-sortIcon field="medico"></p-sortIcon>
        </th>
        <th pSortableColumn="fechaCreacion" class="whitespace-nowrap">
          Fecha <p-sortIcon field="fechaCreacion"></p-sortIcon>
        </th>
        <th pSortableColumn="estado" class="whitespace-nowrap">
          Estado <p-sortIcon field="estado"></p-sortIcon>
        </th>
        <th pSortableColumn="pruebas" class="text-center whitespace-nowrap">
          Pruebas <p-sortIcon field="pruebas"></p-sortIcon>
        </th>
        <th pSortableColumn="total" class="text-right whitespace-nowrap">
          Total <p-sortIcon field="total"></p-sortIcon>
        </th>
        <th class="whitespace-nowrap">Acciones</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-o>
      <tr>
        <td class="font-mono">{{ o.numero }}</td>
        <td>{{ o.paciente }}</td>
        <td>{{ o.medico }}</td>
        <td>{{ o.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}</td>
        <td>
          <p-tag [severity]="getStatusSeverity(o.estado)" [value]="o.estado" styleClass="capitalize"></p-tag>
        </td>
        <td class="text-center">{{ o.pruebas }}</td>
        <td class="text-right">{{ o.total | currency: currencyCode:'symbol-narrow':'1.0-0' }}</td>
        <td class="flex gap-2 flex-wrap">
          <button pButton pTooltip="Ver" class="p-button-sm" icon="pi pi-eye" (click)="onView(o)"
            [routerLink]="['/ordenes/ver', o.id]"></button>
          <button pButton pTooltip="Editar" class="p-button-sm p-button-text" icon="pi pi-pencil"
            (click)="onEdit(o)"></button>
          <button pButton pTooltip="Eliminar" class="p-button-sm p-button-danger p-button-text" icon="pi pi-trash"
            (click)="onDelete(o)"></button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="8" class="text-center italic text-gray-500 py-6">
          No hay resultados que coincidan con ‚Äú{{ globalQuery }}‚Äù.
        </td>
      </tr>
    </ng-template>
  </p-table>
</section>
<!-- Visor de detalles -->
<app-view-order [(visible)]="showView" [order]="selectedDetail" [currencyCode]="currencyCode" [appendToBody]="true"
  (close)="showView=false">
</app-view-order>

<!-- üëá Di√°logo de edici√≥n -->
<app-edit-order-dialog [(visible)]="showEdit" [order]="orderToEdit" [examCatalog]="examCatalog"
  [currencyCode]="currencyCode" (update)="onUpdated($event)" (remove)="onRemoveOrder($event)" (cancel)="showEdit=false">
</app-edit-order-dialog>